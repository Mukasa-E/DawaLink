generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid()) @map("_id")
  email       String   @unique
  name        String
  role        UserRole
  phone       String?
  facilityId  String?  // Healthcare facility ID for providers and facility admins
  specialization String? // Medical specialization for providers
  licenseNumber String? // Professional license for healthcare providers
  isApproved  Boolean  @default(true)  // Approval status for healthcare providers
  approvalStatus ApprovalStatus @default(approved) // pending, approved, rejected
  rejectionReason String? // Reason if rejected
  requestedAt DateTime? // When provider requested to join facility
  approvedAt  DateTime? // When provider was approved
  approvedBy  String?  // ID of admin who approved
  passwordHash String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  facility           Facility? @relation("FacilityUsers", fields: [facilityId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  facilityOwned      Facility? @relation("FacilityOwner")
  referralsSent      Referral[] @relation("ProviderReferrals")
  referralsReceived  Referral[] @relation("PatientReferrals")
  recordsAsPatient   MedicalRecord[] @relation("MedicalRecordPatient")
  recordsAsProvider  MedicalRecord[] @relation("MedicalRecordProvider")
  authorizations     PatientAuthorization[] @relation("PatientAuthPatient")
  providerGrants     PatientAuthorization[] @relation("PatientAuthProvider")
  notifications      Notification[]
  prescriptionsAsPatient Prescription[] @relation("PrescriptionPatient")
  prescriptionsAsProvider Prescription[] @relation("PrescriptionProvider")
  orders               Order[] @relation("OrderPatient")
  
  @@index([facilityId])
  @@index([role])
}

model Facility {
  id                String   @id @default(uuid()) @map("_id")
  name              String
  type              FacilityType // clinic, pharmacy, hospital, health_center
  ownerId           String   @unique
  registrationNumber String  @unique
  phone             String
  email             String
  address           String
  city              String
  county            String?
  operatingHours    Json?   // { open: "08:00", close: "20:00", days: ["Mon", "Tue"] }
  services          String[] // Array of services offered
  isVerified        Boolean  @default(false)
  latitude          Float?
  longitude         Float?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  owner             User @relation("FacilityOwner", fields: [ownerId], references: [id])
  users             User[] @relation("FacilityUsers")
  referralsFrom     Referral[] @relation("ReferringFacility")
  referralsTo       Referral[] @relation("ReceivingFacility")
  records           MedicalRecord[]
  prescriptions     Prescription[]
  orders            Order[] @relation("OrderFacility")
  
  @@index([type])
  @@index([city])
}

model Referral {
  id                 String   @id @default(uuid()) @map("_id")
  referralNumber     String   @unique // Auto-generated referral number
  qrCode             String?  // QR code data for quick access
  patientId          String
  patientName        String
  patientAge         Int?
  patientGender      String?
  providerId         String
  providerName       String
  providerSpecialization String?
  referringFacilityId String
  receivingFacilityId String?
  receivingProviderId String?  // Optional: target specific provider
  reason             String
  clinicalSummary    String   // Brief summary of patient condition
  diagnosis          String?
  vitalSigns         Json?    // Blood pressure, temperature, etc.
  testResults        Json?    // Any lab results or imaging
  treatmentGiven     String?  // Treatment provided before referral
  recommendations    String?
  urgencyLevel       UrgencyLevel @default(routine)
  status             ReferralStatus @default(pending)
  receivedBy         String?  // Name of provider who received referral
  receivedAt         DateTime?
  completionNotes    String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  expiresAt          DateTime? // Optional expiry for referral validity

  patient            User @relation("PatientReferrals", fields: [patientId], references: [id])
  provider           User @relation("ProviderReferrals", fields: [providerId], references: [id])
  referringFacility  Facility @relation("ReferringFacility", fields: [referringFacilityId], references: [id])
  receivingFacility  Facility? @relation("ReceivingFacility", fields: [receivingFacilityId], references: [id])
  
  @@index([patientId])
  @@index([providerId])
  @@index([status])
  @@index([referringFacilityId])
}

model MedicalRecord {
  id           String   @id @default(uuid()) @map("_id")
  recordNumber String   @unique // Auto-generated record number
  patientId    String
  providerId   String
  providerName String
  facilityId   String
  facilityName String
  recordType   RecordType
  title        String
  description  String
  diagnosis    String?
  treatment    String?
  medications  Json?    // Array of medications prescribed
  vitalSigns   Json?    // Blood pressure, temp, pulse, etc.
  labResults   Json?    // Laboratory test results
  attachments  Json?    // File URLs for scans, reports, etc.
  visitDate    DateTime @default(now())
  isConfidential Boolean @default(false)
  shareableViaQR Boolean @default(false) // Can be shared via QR code
  qrCode       String?  // QR code for quick access
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient  User @relation("MedicalRecordPatient", fields: [patientId], references: [id])
  provider User @relation("MedicalRecordProvider", fields: [providerId], references: [id])
  facility Facility @relation(fields: [facilityId], references: [id])
  
  @@index([patientId])
  @@index([facilityId])
  @@index([visitDate])
}

model PatientAuthorization {
  id         String   @id @default(uuid()) @map("_id")
  patientId  String
  providerId String?  // Specific provider access
  facilityId String?  // Or entire facility access
  accessLevel AccessLevel @default(view_only)
  purpose    String?  // Reason for access
  grantedAt  DateTime @default(now())
  expiresAt  DateTime? // Optional expiry
  revokedAt  DateTime?
  isActive   Boolean  @default(true)

  patient  User @relation("PatientAuthPatient", fields: [patientId], references: [id])
  provider User? @relation("PatientAuthProvider", fields: [providerId], references: [id])

  @@index([patientId])
  @@index([providerId])
  @@index([isActive])
}

model Notification {
  id           String           @id @default(uuid()) @map("_id")
  userId       String
  referralId   String?
  recordId     String?
  prescriptionId String?
  orderId      String?
  type         NotificationType
  title        String
  message      String
  isRead       Boolean          @default(false)
  createdAt    DateTime         @default(now())
  
  user         User @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([isRead])
}

// Audit logs for security and compliance. Records who did what and when.
model AuditLog {
  id         String   @id @default(uuid()) @map("_id")
  userId     String?
  userEmail  String?
  userRole   String?
  action     String   // e.g., "view_record", "create_referral", "grant_access"
  resourceType String? // e.g., "medical_record", "referral"
  resourceId String?
  facilityId String?
  detail     Json?
  ip         String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

enum UserRole {
  patient
  healthcare_provider
  facility_admin
  admin
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum FacilityType {
  clinic
  pharmacy
  hospital
  health_center
  diagnostic_center
}

enum RecordType {
  consultation
  test_result
  prescription
  diagnosis
  immunization
  surgery
  follow_up
  other
}

enum ReferralStatus {
  pending
  accepted
  in_progress
  completed
  cancelled
  expired
}

enum UrgencyLevel {
  emergency
  urgent
  routine
}

enum AccessLevel {
  view_only
  full_access
}

enum NotificationType {
  referral_received
  referral_accepted
  referral_completed
  record_shared
  authorization_granted
  authorization_revoked
  appointment_reminder
  system_notification
  prescription_created
  prescription_fulfilled
  prescription_cancelled
  order_created
  order_status_updated
  order_cancelled
  order_delivered
}

// Facility Medicines - medicines available at each facility
model FacilityMedicine {
  id                    String   @id @default(uuid()) @map("_id")
  facilityName          String   // Name of the facility
  name                  String   // Medicine name
  genericName           String?  // Generic/scientific name
  category              String   @default("General") // e.g., Analgesic, Antibiotic
  manufacturer          String?
  dosageForm            String?  // Tablet, Syrup, Injection, etc.
  strength              String?  // e.g., 500mg, 250mg
  stock                 Int      @default(0) // Current stock quantity
  reorderLevel          Int      @default(10) // Minimum stock before reorder
  requiresPrescription  Boolean  @default(false)
  price                 Float    @default(0) // Unit price for ordering
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([facilityName])
  @@index([category])
  @@unique([facilityName, name])
}

// Prescriptions issued by providers/facility admins for patients
model Prescription {
  id               String           @id @default(uuid()) @map("_id")
  prescriptionNumber String         @unique
  patientId        String
  providerId       String
  facilityId       String
  facilityName     String
  diagnosis        String?
  notes            String?
  medicines        Json?            // Array of medicine objects: [{ facilityMedicineId, name, dosage, frequency, duration }]
  status           PrescriptionStatus @default(draft)
  attachmentUrl    String?          // Placeholder for uploaded file (image/pdf)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  patient          User @relation("PrescriptionPatient", fields: [patientId], references: [id])
  provider         User @relation("PrescriptionProvider", fields: [providerId], references: [id])
  facility         Facility @relation(fields: [facilityId], references: [id])

  @@index([patientId])
  @@index([providerId])
  @@index([facilityId])
  @@index([status])
  @@index([facilityId, status, createdAt])
}

// Orders placed by patients against a facility (pharmacy) inventory
model Order {
  id             String      @id @default(uuid()) @map("_id")
  orderNumber    String      @unique
  patientId      String
  facilityId     String      // Facility acting as pharmacy
  facilityName   String
  prescriptionId String?     // Optional associated prescription
  items          Json        // Array: [{ facilityMedicineId, name, quantity, unitPrice, subtotal }]
  totalAmount    Float       @default(0)
  status         OrderStatus @default(pending)
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  patient        User     @relation("OrderPatient", fields: [patientId], references: [id])
  facility       Facility @relation("OrderFacility", fields: [facilityId], references: [id])

  @@index([patientId])
  @@index([facilityId])
  @@index([status])
  @@index([facilityId, status])
}

enum PrescriptionStatus {
  draft
  issued
  fulfilled
  cancelled
  revoked
}

enum OrderStatus {
  pending
  confirmed
  preparing
  ready_for_pickup
  out_for_delivery
  delivered
  cancelled
}
